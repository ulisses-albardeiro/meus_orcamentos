<style>
    /* Estilo para o dropdown de autocomplete */
    #autocomplete-dropdown {
        position: absolute;
        z-index: 1000;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-radius: 0 0 .25rem .25rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
        /* Inicia escondido */
    }

    /* Estilo para o dropdown-menu que o JavaScript mostra/esconde */
    #autocomplete-dropdown.show {
        display: block;
    }

    /* Estilo para os itens do dropdown */
    #autocomplete-dropdown .dropdown-item {
        font-weight: bold;
        /* Deixa a escrita em negrito */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: .5rem 1rem;
        cursor: pointer;
        background-color: #fff;
        color: #212529;
    }

    /* Estilo quando o item é hover */
    #autocomplete-dropdown .dropdown-item:hover,
    #autocomplete-dropdown .dropdown-item:focus {
        background-color: #e9ecef;
        color: #16181b;
    }

    /* Estilo para o item de 'nenhum resultado' */
    #autocomplete-dropdown .dropdown-item.disabled {
        font-style: italic;
        font-weight: normal;
        /* Sobrescreve o negrito */
        color: #6c757d;
        cursor: default;
    }
</style>

<div class="card border-1 shadow-lg p-3">
    <div class="row g-2 mb-3">
        <input type="text" hidden name="id_cliente" id="id_cliente">
        <div class="col-md-5">
            <label class="form-label">Nome*</label>
            <input required type="text" class="form-control form-control-sm" name="nome_cliente" id="nome_cliente"
                autocomplete="off">
            <div id="autocomplete-dropdown" class="dropdown-menu w-25"></div>
        </div>
        <div class="col-md-1">
            <label class="form-label">Telefone Fixo</label>
            <input type="text" class="form-control form-control-sm" id="telefone_cliente" name="telefone_cliente">
        </div>
        <div class="col-md-1">
            <label class="form-label">Celular</label>
            <input type="text" class="form-control form-control-sm" id="celular_cliente" name="celular_cliente">
        </div>
        <div class="col-md-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control form-control-sm" name="email_cliente">
        </div>
        <div class="col-md-2">
            <label class="form-label">CPF/CNPJ</label>
            <input type="text" class="form-control form-control-sm" id="cpf_cnpj_cliente" name="cpf_cnpj_cliente"
                placeholder="00.000.000/0000-00 ou 000.000.000-00" maxlength="18">
        </div>
    </div>

    <div class="row g-2 mb-3">
        <div class="col-md-1">
            <label class="form-label">CEP</label>
            <input type="text" class="form-control form-control-sm" id="cep_cliente" name="cep_cliente"
                placeholder="00000-000" maxlength="9">
        </div>
        <div class="col-md-4">
            <label class="form-label">Rua</label>
            <input type="text" class="form-control form-control-sm" name="rua_cliente">
        </div>
        <div class="col-md-1">
            <label class="form-label">Número</label>
            <input type="text" class="form-control form-control-sm" name="n_casa_cliente">
        </div>
        <div class="col-md-2">
            <label class="form-label">Bairro</label>
            <input type="text" class="form-control form-control-sm" name="bairro_cliente">
        </div>
        <div class="col-md-3">
            <label class="form-label">Cidade</label>
            <input type="text" class="form-control form-control-sm" name="cidade_cliente">
        </div>
        <div class="col-md-1">
            <label class="form-label">UF</label>
            <select id="uf" name="uf_cliente" class="form-select form-select-sm">
                <option value="" selected disabled>UF</option>
                {% for estado in
                ['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO']
                %}
                <option value="{{ estado }}">{{ estado }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<script>
    function dropdownClientes(clients) {
        // Seletores do DOM
        const nomeInput = document.getElementById('nome_cliente');
        const dropdown = document.getElementById('autocomplete-dropdown');
        const clearBtnId = "clear-cliente-btn"; // ID do botão de limpar
        const formFields = {
            id: document.querySelector('[name="id_cliente"]'),
            nome: document.querySelector('[name="nome_cliente"]'),
            telefone: document.querySelector('[name="telefone_cliente"]'),
            celular: document.querySelector('[name="celular_cliente"]'),
            cpf_cnpj: document.querySelector('[name="cpf_cnpj_cliente"]'),
            email: document.querySelector('[name="email_cliente"]'),
            cep: document.querySelector('[name="cep_cliente"]'),
            rua: document.querySelector('[name="rua_cliente"]'),
            n_casa: document.querySelector('[name="n_casa_cliente"]'),
            bairro: document.querySelector('[name="bairro_cliente"]'),
            cidade: document.querySelector('[name="cidade_cliente"]'),
            uf: document.querySelector('[name="uf_cliente"]'),
        };

        // Função para renderizar as opções no dropdown
        function renderDropdown(filteredClients) {
            dropdown.innerHTML = '';
            if (filteredClients.length > 0) {
                filteredClients.forEach(cliente => {
                    const item = document.createElement('a');
                    item.className = 'dropdown-item';
                    item.href = '#';
                    item.textContent = cliente.nome;
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        fillForm(cliente);
                        showClearButton();
                        dropdown.classList.remove('show');
                    });
                    dropdown.appendChild(item);
                });
                dropdown.classList.add('show');
            } else {
                const noResults = document.createElement('span');
                noResults.className = 'dropdown-item disabled text-muted';
                noResults.textContent = 'Nenhum cliente encontrado em seus registros.';
                dropdown.appendChild(noResults);
                dropdown.classList.add('show');
            }
        }

        // Função para preencher todos os campos do formulário
        function fillForm(cliente) {
            formFields.id.value = cliente.id || '';
            formFields.nome.value = cliente.nome || '';
            formFields.telefone.value = cliente.telefone || '';
            formFields.celular.value = cliente.celular || '';
            formFields.cpf_cnpj.value = cliente.cpf_cnpj || '';
            formFields.email.value = cliente.email || '';
            formFields.cep.value = cliente.cep || '';
            formFields.rua.value = cliente.rua || '';
            formFields.n_casa.value = cliente.n_casa || '';
            formFields.bairro.value = cliente.bairro || '';
            formFields.cidade.value = cliente.cidade || '';
            formFields.uf.value = (cliente.uf || '').toUpperCase();
        }

        // Função para limpar os campos
        function clearForm() {
            for (let key in formFields) {
                formFields[key].value = '';
            }
            hideClearButton();
        }

        // Mostrar botão de limpar
        function showClearButton() {
            if (!document.getElementById(clearBtnId)) {
                const btn = document.createElement('button');
                btn.id = clearBtnId;
                btn.type = "button";
                btn.className = "btn btn-sm btn-outline-danger mt-2";
                btn.textContent = "Limpar dados";
                btn.addEventListener('click', clearForm);

                // insere logo abaixo do campo nome_cliente
                nomeInput.insertAdjacentElement('afterend', btn);
            }
        }

        // Esconder/remover botão de limpar
        function hideClearButton() {
            const btn = document.getElementById(clearBtnId);
            if (btn) btn.remove();
        }

        // Evento de 'input' para o campo de nome
        nomeInput.addEventListener('input', () => {
            const query = nomeInput.value.toLowerCase();

            if (query.length > 0) {
                const filteredClients = clients.filter(cliente =>
                    cliente.nome.toLowerCase().includes(query)
                );
                renderDropdown(filteredClients);
            } else {
                dropdown.classList.remove('show');
            }
        });

        // Esconde o dropdown se o usuário clicar fora
        document.addEventListener('click', (e) => {
            if (!nomeInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
    }

    // Obtenha os dados dos clients do Twig e parse o JSON
    const clients = JSON.parse('{{ clients | json_encode() | raw }}');
    dropdownClientes(clients)
</script>